<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Roulette Wheel</title>

<style>
    body {
        font-family: Arial, sans-serif;
        text-align: center;
        background: #222;
        color: #fff;
        margin: 0;
    }

    #loginBox {
        margin-top: 40px;
    }

    #wrapper {
        display: none; /* hide wheel until name is entered */
        position: relative;
        width: 500px;
        margin: 30px auto;
    }

    /* Arrow (RIGHT side pointing inward) */
    #pointer {
        width: 0;
        height: 0;
        border-top: 25px solid transparent;
        border-bottom: 25px solid transparent;
        border-right: 40px solid yellow;
        position: absolute;
        top: 50%;
        right: -5px;
        transform: translateY(-50%);
        z-index: 999;
    }

    #wheelCanvas {
        background: #111;
        border-radius: 50%;
    }

    #spinBtn {
        margin-top: 20px;
        padding: 12px 30px;
        font-size: 20px;
        cursor: pointer;
        border-radius: 10px;
    }
</style>
</head>

<body>

<h1>Realtime Roulette Wheel</h1>

<!-- PLAYER LOGIN -->
<div id="loginBox">
    <h2>Enter Your Name</h2>
    <input id="playerName" placeholder="Your name" style="padding:10px;font-size:18px;">
    <br><br>
    <button onclick="savePlayerName()" style="padding:10px 25px;font-size:18px;">Continue</button>
</div>

<!-- WHEEL -->
<div id="wrapper">
    <div id="pointer"></div>
    <canvas id="wheelCanvas" width="500" height="500"></canvas>
</div>

<button id="spinBtn" style="display:none;">ðŸŽ¡ SPIN</button>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
/* -----------------------------------
   ðŸ”¥ FIREBASE INIT
----------------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCwpRezHGB1lana4k4i5Hd0-v3osGqEXoM",
  authDomain: "roulette-wheel-d1b69.firebaseapp.com",
  databaseURL: "https://roulette-wheel-d1b69-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "roulette-wheel-d1b69",
  storageBucket: "roulette-wheel-d1b69.appspot.com",
  messagingSenderId: "735451237306",
  appId: "1:735451237306:web:cf27ffccf4dc239a3eab83",
  measurementId: "G-B4L2W06CJZ"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* -----------------------------------
   PLAYER NAME LOGIC (OPTION B)
   Name stored locally ONLY
----------------------------------- */
let myName = localStorage.getItem("myName");

function savePlayerName() {
    const input = document.getElementById("playerName").value.trim();

    if (input.length < 1) {
        alert("Enter your name first.");
        return;
    }

    myName = input;

    localStorage.setItem("myName", myName);

    document.getElementById("loginBox").style.display = "none";
    document.getElementById("wrapper").style.display = "block";
    document.getElementById("spinBtn").style.display = "inline-block";

    drawWithRotation();
}

if (myName) {
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("wrapper").style.display = "block";
    document.getElementById("spinBtn").style.display = "inline-block";
}

/* -----------------------------------
   ðŸŽ¡ WHEEL VARIABLES
----------------------------------- */
const canvas = document.getElementById("wheelCanvas");
const ctx = canvas.getContext("2d");

let names = [];
let rotation = 0;
let spinning = false;

/* -----------------------------------
   ðŸŽ¨ DRAW WHEEL
----------------------------------- */
function drawWheel() {
    ctx.clearRect(0, 0, 500, 500);
    if (names.length === 0) return;

    const slices = names.length;
    const anglePerSlice = (2 * Math.PI) / slices;

    for (let i = 0; i < slices; i++) {
        let start = i * anglePerSlice;
        let end = start + anglePerSlice;

        const colors = [
            "#e63946", "#f4a261", "#2a9d8f", "#264653",
            "#e9c46a", "#8a4fff", "#ffbe0b", "#3a86ff"
        ];
        ctx.fillStyle = colors[i % colors.length];

        ctx.beginPath();
        ctx.moveTo(250, 250);
        ctx.arc(250, 250, 250, start, end);
        ctx.closePath();
        ctx.fill();

        ctx.save();
        ctx.translate(250, 250);
        ctx.rotate(start + anglePerSlice / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#fff";
        ctx.font = "20px Arial";
        ctx.fillText(names[i], 230, 10);
        ctx.restore();
    }
}

function drawWithRotation() {
    ctx.save();
    ctx.translate(250, 250);
    ctx.rotate(rotation);
    ctx.translate(-250, -250);
    drawWheel();
    ctx.restore();
}

/* -----------------------------------
   ðŸ”„ REALTIME FIREBASE UPDATE
   Player name NOT included
----------------------------------- */
db.ref("names").on("value", snap => {
    let dbNames = snap.val() ? Object.values(snap.val()) : [];

    if (myName) {
        dbNames = dbNames.filter(n => n !== myName); // remove my name
    }

    names = dbNames;

    rotation = 0;
    drawWheel();
});

/* -----------------------------------
   ðŸŽ¯ SPIN
----------------------------------- */
function spinWheel() {
    if (spinning || names.length === 0) return;

    spinning = true;

    const extraRot = 360 * 10;
    const randomRot = Math.random() * 360;

    const targetDeg = extraRot + randomRot;
    const targetRad = targetDeg * Math.PI / 180;

    let startTime = null;

    function animate(time) {
        if (!startTime) startTime = time;
        const elapsed = time - startTime;

        rotation = (elapsed / 2) * Math.PI / 180;
        drawWithRotation();

        if (elapsed < targetDeg * 2) {
            requestAnimationFrame(animate);
        } else {
            rotation = targetRad;
            spinning = false;
            pickWinner();
        }
    }

    requestAnimationFrame(animate);
}

/* -----------------------------------
   ðŸŽ‰ WINNER CALC + DELETE FROM DB
----------------------------------- */
function pickWinner() {
    const slices = names.length;
    const sliceAngle = 360 / slices;

    let deg = (rotation * 180 / Math.PI) % 360;
    let adjusted = (360 - deg + 360) % 360;

    let index = Math.floor(adjusted / sliceAngle);
    let winner = names[index];

    alert("ðŸŽ‰ Winner: " + winner);

    // Remove from Firebase
    db.ref("names").once("value", snap => {
        let obj = snap.val();
        let keys = Object.keys(obj);

        let originalIndex = Object.values(obj).indexOf(winner);

        db.ref("names/" + keys[originalIndex]).remove();
    });
}

document.getElementById("spinBtn").onclick = spinWheel;
</script>

</body>
</html>
